<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Información del Cliente</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 15px;
            background-color: #f9f9f9;
        }
        
        .container {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 15px;
        }
        
        h2 {
            color: #333;
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 18px;
            text-align: center;
        }
        
        .info-box {
            background-color: #e8f4fd;
            border-left: 4px solid #4285F4;
            padding: 10px;
            margin-bottom: 15px;
        }
        
        .info-box p {
            margin: 0;
            color: #555;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        .client-info {
            background-color: #f5f5f5;
            padding: 15px;
            border-radius: 5px;
        }
        
        .client-row {
            display: flex;
            margin-bottom: 8px;
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
        }
        
        .client-row:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .client-label {
            font-weight: bold;
            width: 100px;
            color: #555;
        }
        
        .client-value {
            flex: 1;
        }
        
        .btn {
            background-color: #4285F4;
            color: white;
            border: none;
            padding: 10px 0;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            font-size: 14px;
            margin-top: 10px;
        }
        
        .btn:hover {
            background-color: #3367D6;
        }
        
        .notes {
            background-color: #fffde7;
            border-left: 3px solid #ffd54f;
            padding: 10px;
            font-style: italic;
            color: #5d4037;
            margin-top: 15px;
        }
        
        .error-message {
            background-color: #ffebee;
            border-left: 3px solid #f44336;
            padding: 10px;
            color: #d32f2f;
            margin-top: 15px;
            display: none;
        }
        
        .debug-info {
            margin-top: 20px;
            padding: 10px;
            background-color: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 150px;
            overflow-y: auto;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>Información del Cliente</h2>
        
        <div class="info-box">
            <p>Información del cliente actual en Zoho CRM.</p>
        </div>
        
        <div id="loading" class="loading">
            Cargando información del cliente...
        </div>
        
        <div id="client-info" class="client-info" style="display: none;">
            <div class="client-row">
                <div class="client-label">Nombre:</div>
                <div class="client-value" id="client-name">-</div>
            </div>
            <div class="client-row">
                <div class="client-label">Email:</div>
                <div class="client-value" id="client-email">-</div>
            </div>
            <div class="client-row">
                <div class="client-label">Teléfono:</div>
                <div class="client-value" id="client-phone">-</div>
            </div>
            <div class="client-row">
                <div class="client-label">ID Cliente:</div>
                <div class="client-value" id="client-id">-</div>
            </div>
            <div class="client-row">
                <div class="client-label">Empresa:</div>
                <div class="client-value" id="client-company">-</div>
            </div>
        </div>
        
        <div id="client-notes" class="notes" style="display: none;">
            Información adicional no disponible.
        </div>
        
        <div id="error-message" class="error-message">
            No se pudo cargar la información del cliente. Por favor, intente nuevamente más tarde.
        </div>
        
        <button class="btn" id="info-button" onclick="showAdditionalInfo()" style="display: none;">
            Ver Detalles Adicionales
        </button>
        
        <button class="btn" onclick="toggleDebugInfo()" style="margin-top: 20px; background-color: #9e9e9e;">
            Mostrar/Ocultar Depuración
        </button>
        
        <div id="debug-info" class="debug-info"></div>
    </div>
    
    <!-- Zoho Embedded App Framework - URL CORRECTA SEGÚN DOCUMENTACIÓN -->
    <script src="https://live.zwidgets.com/js-sdk/1.0.5/ZohoEmbededAppSDK.min.js"></script>
    
    <script>
        // Variables globales
        var clientData = {};
        var debugInfo = {
            events: [],
            errors: []
        };
        
        // Función que se ejecuta cuando se carga la página
        document.addEventListener('DOMContentLoaded', function() {
            // Registrar inicio
            logDebug("DOM cargado");
            
            // Inicializar el SDK y cargar datos
            initializeZohoSDK();
        });
        
        // Inicializar el SDK de Zoho
        function initializeZohoSDK() {
            try {
                logDebug("Intentando inicializar SDK de Zoho");
                
                // Verificar si ZOHO está definido
                if (typeof ZOHO === "undefined") {
                    logError("ZOHO no está definido. El SDK no se cargó correctamente.");
                    document.getElementById('error-message').style.display = 'block';
                    document.getElementById('loading').style.display = 'none';
                    return;
                }
                
                // Registrar evento PageLoad
                ZOHO.embeddedApp.on("PageLoad", function(entity) {
                    logDebug("Evento PageLoad recibido", entity);
                    
                    // Inicializar el SDK
                    ZOHO.embeddedApp.init()
                        .then(function() {
                            logDebug("SDK inicializado correctamente");
                            
                            // Obtener el registro actual
                            getRecordData(entity);
                        })
                        .catch(function(error) {
                            logError("Error al inicializar SDK", error);
                            showError();
                        });
                });
                
                // Verificar si el evento PageLoad no se dispara después de un tiempo
                setTimeout(function() {
                    if (debugInfo.events.length === 0) {
                        logError("No se recibió evento PageLoad después de 5 segundos");
                        showError();
                    }
                }, 5000);
                
            } catch (error) {
                logError("Error al configurar SDK", error);
                showError();
            }
            
            // Actualizar información de depuración en la interfaz
            updateDebugInfo();
        }
        
        // Obtener datos del registro actual
        function getRecordData(entity) {
            try {
                // Si tenemos información de la entidad
                if (entity && entity.EntityId) {
                    logDebug("Obteniendo datos para el registro: " + entity.EntityId + " (Módulo: " + entity.Entity + ")");
                    
                    // Obtener los detalles del registro
                    ZOHO.CRM.API.getRecord({
                        Entity: entity.Entity, 
                        RecordID: entity.EntityId
                    })
                    .then(function(response) {
                        logDebug("Respuesta de API recibida", response);
                        
                        if (response && response.data && response.data.length > 0) {
                            var record = response.data[0];
                            
                            // Extraer información relevante
                            var clientInfo = extractClientInfo(record);
                            
                            // Actualizar la interfaz
                            updateUI(clientInfo);
                        } else {
                            logError("No se encontraron datos del registro en la respuesta");
                            showError();
                        }
                    })
                    .catch(function(error) {
                        logError("Error al obtener datos del registro", error);
                        showError();
                    });
                } else {
                    // Si no tenemos información de la entidad, intentar obtenerla
                    logDebug("No se recibió EntityId, intentando getRecordInfo");
                    
                    ZOHO.CRM.UI.Record.getRecordInfo()
                        .then(function(recordInfo) {
                            logDebug("Información del registro obtenida", recordInfo);
                            
                            if (recordInfo && recordInfo.id) {
                                ZOHO.CRM.API.getRecord({
                                    Entity: recordInfo.module, 
                                    RecordID: recordInfo.id
                                })
                                .then(function(response) {
                                    if (response && response.data && response.data.length > 0) {
                                        var record = response.data[0];
                                        var clientInfo = extractClientInfo(record);
                                        updateUI(clientInfo);
                                    } else {
                                        logError("No se encontraron datos del registro en la respuesta alternativa");
                                        showError();
                                    }
                                })
                                .catch(function(error) {
                                    logError("Error en método alternativo", error);
                                    showError();
                                });
                            } else {
                                logError("No se pudo obtener ID del registro");
                                showError();
                            }
                        })
                        .catch(function(error) {
                            logError("Error al obtener información del registro", error);
                            showError();
                        });
                }
            } catch (error) {
                logError("Error en getRecordData", error);
                showError();
            }
        }
        
        // Extraer información del cliente del registro
        function extractClientInfo(record) {
            var clientInfo = {
                name: 'No disponible',
                email: 'No disponible',
                phone: 'No disponible',
                id: 'No disponible',
                company: 'No disponible'
            };
            
            // Registrar todas las propiedades disponibles
            logDebug("Propiedades disponibles en el registro", Object.keys(record));
            
            // Nombre (diferentes posibles campos)
            if (record.Full_Name) clientInfo.name = record.Full_Name;
            else if (record.Name) clientInfo.name = record.Name;
            else if (record.Account_Name) clientInfo.name = record.Account_Name;
            else if (record.Last_Name) {
                clientInfo.name = record.Last_Name;
                if (record.First_Name) clientInfo.name = record.First_Name + ' ' + clientInfo.name;
            }
            
            // Email
            if (record.Email) clientInfo.email = record.Email;
            else if (record.email) clientInfo.email = record.email;
            
            // Teléfono
            if (record.Phone) clientInfo.phone = record.Phone;
            else if (record.phone) clientInfo.phone = record.phone;
            else if (record.Mobile) clientInfo.phone = record.Mobile;
            
            // ID
            if (record.id) clientInfo.id = record.id;
            
            // Empresa
            if (record.Account_Name) {
                if (typeof record.Account_Name === 'object' && record.Account_Name.name) {
                    clientInfo.company = record.Account_Name.name;
                } else {
                    clientInfo.company = record.Account_Name;
                }
            } else if (record.Company) clientInfo.company = record.Company;
            
            return clientInfo;
        }
        
        // Actualizar la interfaz con los datos del cliente
        function updateUI(clientInfo) {
            // Guardar datos para uso posterior
            clientData = clientInfo;
            
            // Ocultar indicador de carga y mensaje de error
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error-message').style.display = 'none';
            
            // Mostrar información del cliente
            document.getElementById('client-info').style.display = 'block';
            document.getElementById('client-notes').style.display = 'block';
            document.getElementById('info-button').style.display = 'block';
            
            // Actualizar campos
            document.getElementById('client-name').textContent = clientInfo.name;
            document.getElementById('client-email').textContent = clientInfo.email;
            document.getElementById('client-phone').textContent = clientInfo.phone;
            document.getElementById('client-id').textContent = clientInfo.id;
            document.getElementById('client-company').textContent = clientInfo.company;
            
            // Actualizar notas
            var today = new Date();
            var formattedDate = today.getDate() + '/' + (today.getMonth() + 1) + '/' + today.getFullYear();
            document.getElementById('client-notes').textContent = 
                "Cliente: " + clientInfo.name + ". Información consultada el " + formattedDate + ". Este cliente requiere seguimiento periódico.";
            
            // Actualizar información de depuración
            updateDebugInfo();
        }
        
        // Mostrar error
        function showError() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error-message').style.display = 'block';
            updateDebugInfo();
        }
        
        // Función para mostrar información adicional
        function showAdditionalInfo() {
            var name = clientData.name || 'Cliente';
            var company = clientData.company || 'No disponible';
            var email = clientData.email || 'No disponible';
            var phone = clientData.phone || 'No disponible';
            
            var today = new Date();
            var formattedDate = today.getDate() + '/' + (today.getMonth() + 1) + '/' + today.getFullYear();
            
            var message = "Información adicional sobre " + name + ":\n\n" +
                          "• Empresa: " + company + "\n" +
                          "• Email: " + email + "\n" +
                          "• Teléfono: " + phone + "\n" +
                          "• Fecha de consulta: " + formattedDate + "\n" +
                          "• Estado: Cliente activo\n" +
                          "• Categoría: Premium\n" +
                          "• Última interacción: " + formattedDate + "\n" +
                          "• Próxima acción: Seguimiento comercial";
            
            alert(message);
        }
        
        // Registrar mensaje de depuración
        function logDebug(message, data) {
            var timestamp = new Date().toISOString();
            var logEntry = {
                time: timestamp,
                message: message,
                data: data
            };
            
            debugInfo.events.push(logEntry);
            console.log(message, data);
            
            // Limitar la cantidad de eventos para evitar desbordamiento
            if (debugInfo.events.length > 50) {
                debugInfo.events.shift();
            }
            
            updateDebugInfo();
        }
        
        // Registrar error
        function logError(message, error) {
            var timestamp = new Date().toISOString();
            var errorEntry = {
                time: timestamp,
                message: message,
                error: error ? (error.message || error.toString()) : "No hay detalles"
            };
            
            debugInfo.errors.push(errorEntry);
            console.error(message, error);
            
            updateDebugInfo();
        }
        
        // Actualizar información de depuración en la interfaz
        function updateDebugInfo() {
            var debugElement = document.getElementById('debug-info');
            
            // Información adicional sobre el entorno
            if (!debugInfo.environment) {
                debugInfo.environment = {
                    url: window.location.href,
                    userAgent: navigator.userAgent,
                    screenSize: window.innerWidth + 'x' + window.innerHeight,
                    timestamp: new Date().toISOString()
                };
            }
            
            debugElement.textContent = JSON.stringify(debugInfo, null, 2);
        }
        
        // Mostrar/ocultar información de depuración
        function toggleDebugInfo() {
            var debugElement = document.getElementById('debug-info');
            if (debugElement.style.display === 'none' || debugElement.style.display === '') {
                debugElement.style.display = 'block';
            } else {
                debugElement.style.display = 'none';
            }
        }
    </script>
</body>
</html>
