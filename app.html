<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Información del Cliente</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 15px;
            background-color: #f9f9f9;
        }
        
        .container {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 15px;
        }
        
        h2 {
            color: #333;
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 18px;
            text-align: center;
        }
        
        .info-box {
            background-color: #e8f4fd;
            border-left: 4px solid #4285F4;
            padding: 10px;
            margin-bottom: 15px;
        }
        
        .info-box p {
            margin: 0;
            color: #555;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        .client-info {
            background-color: #f5f5f5;
            padding: 15px;
            border-radius: 5px;
        }
        
        .client-row {
            display: flex;
            margin-bottom: 8px;
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
        }
        
        .client-row:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .client-label {
            font-weight: bold;
            width: 100px;
            color: #555;
        }
        
        .client-value {
            flex: 1;
        }
        
        .btn {
            background-color: #4285F4;
            color: white;
            border: none;
            padding: 10px 0;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            font-size: 14px;
            margin-top: 10px;
        }
        
        .btn:hover {
            background-color: #3367D6;
        }
        
        .notes {
            background-color: #fffde7;
            border-left: 3px solid #ffd54f;
            padding: 10px;
            font-style: italic;
            color: #5d4037;
            margin-top: 15px;
        }
        
        .error-message {
            background-color: #ffebee;
            border-left: 3px solid #f44336;
            padding: 10px;
            color: #d32f2f;
            margin-top: 15px;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>Información del Cliente</h2>
        
        <div class="info-box">
            <p>Este widget muestra la información del contacto actual.</p>
        </div>
        
        <div id="loading" class="loading">
            Cargando información del cliente...
        </div>
        
        <div id="client-info" class="client-info" style="display: none;">
            <div class="client-row">
                <div class="client-label">Nombre:</div>
                <div class="client-value" id="client-name">-</div>
            </div>
            <div class="client-row">
                <div class="client-label">Email:</div>
                <div class="client-value" id="client-email">-</div>
            </div>
            <div class="client-row">
                <div class="client-label">Teléfono:</div>
                <div class="client-value" id="client-phone">-</div>
            </div>
            <div class="client-row">
                <div class="client-label">ID Cliente:</div>
                <div class="client-value" id="client-id">-</div>
            </div>
            <div class="client-row">
                <div class="client-label">Empresa:</div>
                <div class="client-value" id="client-company">-</div>
            </div>
        </div>
        
        <div id="client-notes" class="notes" style="display: none;">
            Información adicional no disponible.
        </div>
        
        <div id="error-message" class="error-message">
            No se pudo cargar la información del cliente. Por favor, intente nuevamente más tarde.
        </div>
        
        <button class="btn" id="info-button" onclick="showAdditionalInfo()" style="display: none;">
            Ver Detalles Adicionales
        </button>
    </div>
    
    <script src="https://js.zohostatic.com/zohocrm/v2.0/sdk/3.0.0/js/ZohoCrmInc.min.js"></script>
    
    <script>
        // Variables globales
        var clientData = {};
        
        // Función que se ejecuta cuando se carga la página
        document.addEventListener('DOMContentLoaded', function() {
            // Inicializar y cargar datos
            initializeWidget();
        });
        
        // Inicializar el widget
        function initializeWidget() {
            try {
                ZOHO.embeddedApp.on("PageLoad", function(entity) {
                    console.log("PageLoad evento detectado");
                    
                    // Inicializar el SDK
                    ZOHO.embeddedApp.init().then(function() {
                        console.log("SDK inicializado correctamente");
                        
                        // Extraer datos usando los IDs específicos de Zoho
                        try {
                            // Intentar obtener datos directamente del DOM
                            getDataFromDOM();
                        } catch (error) {
                            console.error("Error al obtener datos del DOM:", error);
                            
                            // Si falla, intentar con el método API
                            getDataFromAPI();
                        }
                    });
                });
            } catch (error) {
                console.error("Error al inicializar:", error);
                showError();
            }
        }
        
        // Obtener datos directamente del DOM usando IDs específicos de Zoho
        function getDataFromDOM() {
            // Verificar acceso al DOM del padre
            if (window.parent && window.parent.document) {
                var parentDoc = window.parent.document;
                
                // Buscar elementos por sus IDs específicos
                var record_id = null;
                var name = '';
                var email = '';
                var phone = '';
                var company = '';
                
                try {
                    // Intentar obtener el ID del registro
                    var record_id_element = parentDoc.getElementById('record_id');
                    if (record_id_element) {
                        record_id = record_id_element.value;
                    }
                    
                    // Intentar obtener el nombre del contacto
                    var contact_name_element = parentDoc.getElementById('Contact_Name');
                    if (contact_name_element) {
                        name = contact_name_element.value;
                    }
                    
                    // Si no encontramos el nombre, buscar por el elemento Full_Name
                    if (!name) {
                        var full_name_element = parentDoc.getElementById('Full_Name');
                        if (full_name_element) {
                            name = full_name_element.value;
                        }
                    }
                    
                    // Intentar obtener el email
                    var email_element = parentDoc.getElementById('Contact_Email');
                    if (email_element) {
                        email = email_element.value;
                    }
                    
                    // Si no encontramos el email, buscar por el elemento Email
                    if (!email) {
                        var email_standard_element = parentDoc.getElementById('Email');
                        if (email_standard_element) {
                            email = email_standard_element.value;
                        }
                    }
                    
                    // Intentar obtener el teléfono usando el ID específico mencionado
                    var phone_element = parentDoc.getElementById('subvalue_PHONE');
                    if (phone_element) {
                        phone = phone_element.textContent || phone_element.innerText;
                    }
                    
                    // Si no encontramos el teléfono, buscar por otros IDs posibles
                    if (!phone) {
                        var phone_standard_element = parentDoc.getElementById('Phone');
                        if (phone_standard_element) {
                            phone = phone_standard_element.value;
                        }
                    }
                    
                    if (!phone) {
                        var contact_mobile_element = parentDoc.getElementById('Contact_Mobile');
                        if (contact_mobile_element) {
                            phone = contact_mobile_element.value;
                        }
                    }
                    
                    // Intentar obtener el nombre de la empresa
                    var company_element = parentDoc.getElementById('Company_name');
                    if (company_element) {
                        company = company_element.value;
                    }
                    
                    // Si no encontramos la empresa, buscar por el elemento Account_Name
                    if (!company) {
                        var account_name_element = parentDoc.getElementById('Account_Name');
                        if (account_name_element) {
                            company = account_name_element.value;
                        }
                    }
                    
                    // Actualizar la interfaz con los datos encontrados
                    if (name || email || phone || record_id || company) {
                        updateClientInfo({
                            name: name || 'No disponible',
                            email: email || 'No disponible',
                            phone: phone || 'No disponible',
                            id: record_id || 'No disponible',
                            company: company || 'No disponible'
                        });
                    } else {
                        // Si no encontramos datos, intentar con la API
                        getDataFromAPI();
                    }
                } catch (error) {
                    console.error("Error al procesar elementos del DOM:", error);
                    getDataFromAPI();
                }
            } else {
                console.log("No se puede acceder al DOM padre, usando API");
                getDataFromAPI();
            }
        }
        
        // Obtener datos usando la API de Zoho CRM
        function getDataFromAPI() {
            try {
                // Obtener el ID y módulo del registro actual
                ZOHO.CRM.UI.Record.getEntityId()
                    .then(function(data) {
                        if (data && data.data && data.data.length > 0) {
                            var recordId = data.data[0].id;
                            var moduleAPIName = data.data[0].module;
                            
                            console.log("Registro actual:", moduleAPIName, recordId);
                            
                            // Obtener los detalles del registro
                            return ZOHO.CRM.API.getRecord({
                                Entity: moduleAPIName, 
                                RecordID: recordId
                            });
                        } else {
                            throw new Error("No se pudo obtener el ID del registro");
                        }
                    })
                    .then(function(response) {
                        if (response && response.data && response.data.length > 0) {
                            var record = response.data[0];
                            console.log("Datos del registro API:", record);
                            
                            // Extraer información relevante
                            clientData = {
                                name: record.Full_Name || record.Name || record.Last_Name || 'No disponible',
                                email: record.Email || 'No disponible',
                                phone: record.Phone || record.Mobile || 'No disponible',
                                id: record.id || 'No disponible',
                                company: record.Company || record.Account_Name || 'No disponible'
                            };
                            
                            // Actualizar la interfaz
                            updateClientInfo(clientData);
                        } else {
                            throw new Error("No se encontraron datos del registro");
                        }
                    })
                    .catch(function(error) {
                        console.error("Error al obtener datos de API:", error);
                        showDemoData();
                    });
            } catch (e) {
                console.error("Error en getDataFromAPI:", e);
                showDemoData();
            }
        }
        
        // Actualizar la interfaz con los datos del cliente
        function updateClientInfo(data) {
            // Ocultar indicador de carga
            document.getElementById('loading').style.display = 'none';
            
            // Mostrar información del cliente
            document.getElementById('client-info').style.display = 'block';
            document.getElementById('client-notes').style.display = 'block';
            document.getElementById('info-button').style.display = 'block';
            
            // Actualizar campos
            document.getElementById('client-name').textContent = data.name;
            document.getElementById('client-email').textContent = data.email;
            document.getElementById('client-phone').textContent = data.phone;
            document.getElementById('client-id').textContent = data.id;
            document.getElementById('client-company').textContent = data.company;
            
            // Actualizar notas
            var today = new Date();
            var formattedDate = today.getDate() + '/' + (today.getMonth() + 1) + '/' + today.getFullYear();
            document.getElementById('client-notes').textContent = 
                "Cliente: " + data.name + ". Información consultada el " + formattedDate + ". Este cliente requiere seguimiento periódico.";
            
            // Guardar datos para usar en otras funciones
            clientData = data;
        }
        
        // Mostrar datos de demostración (cuando no se pueden obtener datos reales)
        function showDemoData() {
            // Datos de ejemplo
            var demoData = {
                name: "Cliente de Demostración",
                email: "demo@ejemplo.com",
                phone: "123-456-7890",
                id: "12345",
                company: "Empresa Demo"
            };
            
            // Actualizar la interfaz con datos de ejemplo
            updateClientInfo(demoData);
        }
        
        // Mostrar error
        function showError() {
            // Ocultar indicador de carga
            document.getElementById('loading').style.display = 'none';
            
            // Mostrar mensaje de error
            document.getElementById('error-message').style.display = 'block';
            
            // Mostrar datos de demostración
            showDemoData();
        }
        
        // Función para mostrar información adicional
        function showAdditionalInfo() {
            var name = clientData.name || document.getElementById('client-name').textContent;
            var company = clientData.company || document.getElementById('client-company').textContent;
            
            var today = new Date();
            var formattedDate = today.getDate() + '/' + (today.getMonth() + 1) + '/' + today.getFullYear();
            
            var message = "Información adicional sobre " + name + ":\n\n" +
                          "• Empresa: " + company + "\n" +
                          "• Fecha de consulta: " + formattedDate + "\n" +
                          "• Estado: Cliente activo\n" +
                          "• Categoría: Premium\n" +
                          "• Última interacción: " + formattedDate + "\n" +
                          "• Próxima acción: Seguimiento comercial";
            
            alert(message);
        }
    </script>
</body>
</html>
