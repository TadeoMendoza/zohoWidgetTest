<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Información del Cliente</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f9f9f9;
        }
        
        .container {
            max-width: 500px;
            width: 100%;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
            margin: 0 auto;
        }
        
        h1 {
            color: #333;
            font-size: 24px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .info-box {
            background-color: #e8f4fd;
            border-left: 4px solid #4285F4;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .info-box p {
            color: #666;
            line-height: 1.6;
            margin: 0;
        }
        
        .client-info {
            background-color: #f5f5f5;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        .client-info-row {
            display: flex;
            margin-bottom: 10px;
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
        }
        
        .client-info-row:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .client-info-label {
            font-weight: bold;
            width: 120px;
            color: #555;
        }
        
        .client-info-value {
            flex: 1;
            color: #333;
        }
        
        .action-button {
            background-color: #4285F4;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
            transition: background-color 0.3s;
        }
        
        .action-button:hover {
            background-color: #3367D6;
        }
        
        .notes-section {
            margin-top: 20px;
            border-top: 1px solid #eee;
            padding-top: 15px;
        }
        
        .notes-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #555;
        }
        
        .notes-content {
            background-color: #fffde7;
            padding: 10px;
            border-radius: 4px;
            border-left: 3px solid #ffd54f;
            font-style: italic;
            color: #5d4037;
        }
        
        .loading {
            text-align: center;
            color: #666;
            padding: 20px;
        }
        
        .empty-message {
            color: #888;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Información del Cliente</h1>
        
        <div class="info-box">
            <p>Resumen de la información del contacto actual. Estos datos son extraídos directamente de la ficha de Zoho CRM.</p>
        </div>
        
        <div id="loading" class="loading">Extrayendo información del cliente...</div>
        
        <div class="client-info" id="client-info" style="display: none;">
            <div class="client-info-row">
                <div class="client-info-label">Nombre:</div>
                <div class="client-info-value" id="client-name"><span class="empty-message">No disponible</span></div>
            </div>
            <div class="client-info-row">
                <div class="client-info-label">Email:</div>
                <div class="client-info-value" id="client-email"><span class="empty-message">No disponible</span></div>
            </div>
            <div class="client-info-row">
                <div class="client-info-label">Teléfono:</div>
                <div class="client-info-value" id="client-phone"><span class="empty-message">No disponible</span></div>
            </div>
            <div class="client-info-row">
                <div class="client-info-label">ID Cliente:</div>
                <div class="client-info-value" id="client-id"><span class="empty-message">No disponible</span></div>
            </div>
            <div class="client-info-row">
                <div class="client-info-label">Estado:</div>
                <div class="client-info-value" id="client-status"><span class="empty-message">No disponible</span></div>
            </div>
        </div>
        
        <div class="notes-section" id="notes-section" style="display: none;">
            <div class="notes-title">Notas:</div>
            <div class="notes-content" id="client-notes">
                <span class="empty-message">No hay notas disponibles para este cliente</span>
            </div>
        </div>
        
        <button class="action-button" id="action-button" onclick="showAdditionalInfo()">Ver Detalles Adicionales</button>
    </div>

    <script>
        // Función que se ejecuta cuando se carga la página
        document.addEventListener('DOMContentLoaded', function() {
            // Intentar extraer datos del cliente
            extractClientData();
        });
        
        // Extraer datos del cliente desde la página principal
        function extractClientData() {
            // Mostrar indicador de carga
            document.getElementById('loading').style.display = 'block';
            document.getElementById('client-info').style.display = 'none';
            document.getElementById('notes-section').style.display = 'none';
            
            try {
                // Intentar diferentes métodos para extraer datos
                extractDataFromDOM();
                
                // Ocultar indicador de carga después de un breve período
                setTimeout(function() {
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('client-info').style.display = 'block';
                    document.getElementById('notes-section').style.display = 'block';
                }, 1000);
            } catch (e) {
                console.error("Error al extraer datos:", e);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('client-info').style.display = 'block';
                document.getElementById('notes-section').style.display = 'block';
            }
        }
        
        // Extraer datos del DOM
        function extractDataFromDOM() {
            try {
                // Intentar acceder al documento padre (Zoho CRM)
                if (window.parent && window.parent.document) {
                    var parentDoc = window.parent.document;
                    var clientData = {};
                    
                    // Extraer datos directamente de elementos en la página
                    extractFieldsFromDocument(parentDoc, clientData);
                    
                    // Si no se encontró nombre, intentar extraerlo del título
                    if (!clientData.name) {
                        var pageTitle = parentDoc.title || '';
                        var nameMatch = pageTitle.match(/^([^|]+)/);
                        if (nameMatch && nameMatch[1] && nameMatch[1].trim()) {
                            clientData.name = nameMatch[1].trim();
                        }
                    }
                    
                    // Si no se encontró ID, intentar extraerlo de la URL
                    if (!clientData.id) {
                        var url = window.parent.location.href;
                        var matches = url.match(/\/(\d+)($|\?|\/)/);
                        if (matches && matches[1]) {
                            clientData.id = matches[1];
                        }
                    }
                    
                    // Actualizar la interfaz con los datos encontrados
                    updateClientInfo(clientData);
                } else {
                    // Si no podemos acceder al documento padre, intentar con el documento actual
                    var clientData = {};
                    extractFieldsFromDocument(document, clientData);
                    updateClientInfo(clientData);
                }
            } catch (e) {
                console.error("Error al extraer datos del DOM:", e);
                // No hacer nada más, la interfaz ya muestra "No disponible" por defecto
            }
        }
        
        // Extraer campos del documento
        function extractFieldsFromDocument(doc, data) {
            // Funciones auxiliares para extraer datos de elementos
            function extractText(elements) {
                if (!elements || elements.length === 0) return '';
                for (var i = 0; i < elements.length; i++) {
                    var text = elements[i].textContent;
                    if (text && text.trim() !== '') {
                        return text.trim();
                    }
                }
                return '';
            }
            
            // Buscar elementos por atributos data-fieldname
            var nameElements = doc.querySelectorAll('[data-fieldname="Full_Name"], [data-fieldname="Name"], [data-fieldname="Contact_Name"]');
            var emailElements = doc.querySelectorAll('[data-fieldname="Email"]');
            var phoneElements = doc.querySelectorAll('[data-fieldname="Phone"]');
            var idElements = doc.querySelectorAll('[data-fieldname="CustomerID"], [data-fieldname="ContactID"], [data-fieldname="Customer_ID"]');
            var statusElements = doc.querySelectorAll('[data-fieldname="Status"], [data-fieldname="Contact_Status"]');
            
            // Extraer datos de los elementos encontrados
            data.name = extractText(nameElements);
            data.email = extractText(emailElements);
            data.phone = extractText(phoneElements);
            data.id = extractText(idElements);
            data.status = extractText(statusElements);
            
            // Buscar también por clases o IDs específicos que puedan contener esta información
            if (!data.email) {
                var emailLinks = doc.querySelectorAll('a[href^="mailto:"]');
                if (emailLinks && emailLinks.length > 0) {
                    for (var i = 0; i < emailLinks.length; i++) {
                        var href = emailLinks[i].getAttribute('href');
                        if (href) {
                            data.email = href.replace('mailto:', '');
                            break;
                        }
                    }
                }
            }
            
            // Buscar elementos por etiquetas comunes
            var labels = doc.querySelectorAll('label, th');
            for (var i = 0; i < labels.length; i++) {
                var label = labels[i].textContent.toLowerCase();
                var value = '';
                
                // Buscar el valor asociado a esta etiqueta
                var nextElement = labels[i].nextElementSibling;
                if (nextElement) {
                    value = nextElement.textContent.trim();
                }
                
                // Si no hay elemento siguiente, buscar en el padre
                if (!value && labels[i].parentElement) {
                    var siblings = labels[i].parentElement.children;
                    for (var j = 0; j < siblings.length; j++) {
                        if (siblings[j] !== labels[i] && siblings[j].textContent.trim()) {
                            value = siblings[j].textContent.trim();
                            break;
                        }
                    }
                }
                
                // Asignar valores según la etiqueta
                if (value) {
                    if (label.includes('nombre') && !data.name) {
                        data.name = value;
                    } else if (label.includes('email') && !data.email) {
                        data.email = value;
                    } else if (label.includes('teléfono') || label.includes('telefono') || label.includes('phone') && !data.phone) {
                        data.phone = value;
                    } else if ((label.includes('id') || label.includes('código') || label.includes('codigo')) && !data.id) {
                        data.id = value;
                    } else if (label.includes('estado') || label.includes('status') && !data.status) {
                        data.status = value;
                    }
                }
            }
        }
        
        // Actualizar la interfaz con los datos del cliente
        function updateClientInfo(data) {
            // Función auxiliar para actualizar elementos
            function updateElement(id, value) {
                var element = document.getElementById(id);
                if (element) {
                    if (value) {
                        element.textContent = value;
                    } else {
                        element.innerHTML = '<span class="empty-message">No disponible</span>';
                    }
                }
            }
            
            // Actualizar cada campo con los datos obtenidos
            updateElement('client-name', data.name);
            updateElement('client-email', data.email);
            updateElement('client-phone', data.phone);
            updateElement('client-id', data.id);
            updateElement('client-status', data.status || 'Activo');
            
            // Actualizar las notas con información dinámica
            var today = new Date();
            var formattedDate = today.getDate() + '/' + (today.getMonth() + 1) + '/' + today.getFullYear();
            
            var notesText = 'Información extraída el ' + formattedDate + '. ';
            if (data.name) {
                notesText += 'Cliente: ' + data.name + '. ';
            }
            notesText += 'Se recomienda verificar periódicamente los datos de contacto.';
            
            updateElement('client-notes', notesText);
        }
        
        // Función para mostrar información adicional
        function showAdditionalInfo() {
            var clientName = document.getElementById('client-name').textContent;
            var clientId = document.getElementById('client-id').textContent;
            var clientEmail = document.getElementById('client-email').textContent;
            var clientPhone = document.getElementById('client-phone').textContent;
            
            // Verificar si los datos son los valores predeterminados
            if (clientName.includes('No disponible')) {
                clientName = 'cliente actual';
            }
            if (clientId.includes('No disponible')) {
                clientId = '';
            }
            
            var today = new Date();
            var formattedDate = today.getDate() + '/' + (today.getMonth() + 1) + '/' + today.getFullYear();
            
            var message = "Información adicional sobre " + clientName;
            if (clientId) {
                message += " (ID: " + clientId + ")";
            }
            message += ":\n\n";
            
            message += "• Fecha de consulta: " + formattedDate + "\n";
            
            if (clientEmail && !clientEmail.includes('No disponible')) {
                message += "• Email de contacto: " + clientEmail + "\n";
            }
            
            if (clientPhone && !clientPhone.includes('No disponible')) {
                message += "• Teléfono: " + clientPhone + "\n";
            }
            
            message += "• Estado: Contacto activo\n";
            message += "• Acción recomendada: Seguimiento comercial";
            
            alert(message);
        }
    </script>
</body>
</html>
