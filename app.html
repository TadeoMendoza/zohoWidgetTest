<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Diagnóstico de Widget Zoho</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 15px;
            background-color: #f9f9f9;
        }
        
        .container {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 15px;
        }
        
        h2 {
            color: #333;
            margin-top: 0;
            font-size: 20px;
        }
        
        .status-box {
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
        }
        
        .status-ok {
            background-color: #e8f5e9;
            border-left: 4px solid #4caf50;
        }
        
        .status-warning {
            background-color: #fff8e1;
            border-left: 4px solid #ffc107;
        }
        
        .status-error {
            background-color: #ffebee;
            border-left: 4px solid #f44336;
        }
        
        .btn {
            background-color: #4285F4;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px 0;
        }
        
        .btn-alt {
            background-color: #9e9e9e;
        }
        
        .btn:hover {
            opacity: 0.9;
        }
        
        .log-container {
            background-color: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
            height: 200px;
            overflow-y: auto;
            margin-top: 10px;
        }
        
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-bottom: 1px solid #eee;
        }
        
        .log-info {
            color: #333;
        }
        
        .log-warning {
            color: #f57c00;
        }
        
        .log-error {
            color: #d32f2f;
        }
        
        .log-success {
            color: #388e3c;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>Diagnóstico de Widget para Zoho CRM</h2>
        
        <div id="sdk-status" class="status-box status-warning">
            Verificando disponibilidad del SDK de Zoho...
        </div>
        
        <div>
            <button class="btn" onclick="checkZohoSDK()">Verificar SDK de Zoho</button>
            <button class="btn" onclick="attemptInitialize()">Intentar Inicialización</button>
            <button class="btn btn-alt" onclick="clearLog()">Limpiar Registro</button>
        </div>
        
        <h3>Registro de Eventos</h3>
        <div id="log-container" class="log-container"></div>
        
        <div style="margin-top: 20px;">
            <button class="btn" onclick="showEnvironmentInfo()">Mostrar Información del Entorno</button>
        </div>
    </div>
    
    <!-- Probar con tres URLs diferentes del SDK de Zoho -->
    <script>
        // Variables globales
        var sdkLoaded = false;
        var sdkInitialized = false;
        
        // Función que se ejecuta cuando se carga la página
        document.addEventListener('DOMContentLoaded', function() {
            logInfo("Página cargada. Iniciando diagnóstico...");
            
            // Verificar si ZOHO ya está definido (por si se cargó antes)
            if (typeof ZOHO !== "undefined") {
                sdkLoaded = true;
                logSuccess("SDK de Zoho ya está cargado en la página");
                updateSDKStatus(true);
            } else {
                logWarning("SDK de Zoho no detectado inicialmente");
                
                // Intentar cargar el SDK de Zoho (3 URLs diferentes)
                loadZohoSDK();
            }
            
            // Registrar información de la URL
            logInfo("URL actual: " + window.location.href);
            logInfo("Referrer: " + document.referrer);
        });
        
        // Cargar el SDK de Zoho
        function loadZohoSDK() {
            logInfo("Intentando cargar el SDK de Zoho...");
            
            // Opción 1: URL mencionada en la documentación compartida
            loadScript("https://live.zwidgets.com/js-sdk/1.0.5/ZohoEmbededAppSDK.min.js", function() {
                if (typeof ZOHO !== "undefined") {
                    sdkLoaded = true;
                    logSuccess("SDK de Zoho cargado exitosamente (Opción 1)");
                    updateSDKStatus(true);
                } else {
                    logError("SDK de Zoho no se cargó correctamente (Opción 1)");
                    
                    // Opción 2: URL alternativa
                    loadScript("https://js.zohostatic.com/zohocrm/v2.0/sdk/3.0.0/js/ZohoCrmInc.min.js", function() {
                        if (typeof ZOHO !== "undefined") {
                            sdkLoaded = true;
                            logSuccess("SDK de Zoho cargado exitosamente (Opción 2)");
                            updateSDKStatus(true);
                        } else {
                            logError("SDK de Zoho no se cargó correctamente (Opción 2)");
                            
                            // Opción 3: URL mencionada en tu código
                            loadScript("https://js.zohostatic.com/zohocrm/v1.0/sdk/ZCRMClientSdk.min.js", function() {
                                if (typeof ZOHO !== "undefined") {
                                    sdkLoaded = true;
                                    logSuccess("SDK de Zoho cargado exitosamente (Opción 3)");
                                    updateSDKStatus(true);
                                } else {
                                    logError("No se pudo cargar el SDK de Zoho después de intentar 3 URLs diferentes");
                                    updateSDKStatus(false);
                                }
                            });
                        }
                    });
                }
            });
        }
        
        // Función para cargar script dinámicamente
        function loadScript(url, callback) {
            var script = document.createElement("script");
            script.type = "text/javascript";
            
            if (script.readyState) {  // IE
                script.onreadystatechange = function() {
                    if (script.readyState === "loaded" || script.readyState === "complete") {
                        script.onreadystatechange = null;
                        setTimeout(callback, 500);
                    }
                };
            } else {  // Otros navegadores
                script.onload = function() {
                    setTimeout(callback, 500);
                };
            }
            
            script.onerror = function() {
                logError("Error al cargar script: " + url);
                callback();
            };
            
            script.src = url;
            document.getElementsByTagName("head")[0].appendChild(script);
            logInfo("Intentando cargar script: " + url);
        }
        
        // Verificar SDK de Zoho
        function checkZohoSDK() {
            if (typeof ZOHO !== "undefined") {
                logSuccess("SDK de Zoho está disponible");
                sdkLoaded = true;
                updateSDKStatus(true);
                
                // Verificar propiedades disponibles
                var properties = [];
                for (var prop in ZOHO) {
                    properties.push(prop);
                }
                
                logInfo("Propiedades disponibles en ZOHO: " + properties.join(", "));
                
                if (ZOHO.embeddedApp) {
                    logSuccess("ZOHO.embeddedApp está disponible");
                } else {
                    logError("ZOHO.embeddedApp no está disponible");
                }
                
                if (ZOHO.CRM) {
                    logSuccess("ZOHO.CRM está disponible");
                } else {
                    logError("ZOHO.CRM no está disponible");
                }
            } else {
                logError("SDK de Zoho no está disponible");
                sdkLoaded = false;
                updateSDKStatus(false);
            }
        }
        
        // Intentar inicializar el SDK
        function attemptInitialize() {
            if (!sdkLoaded) {
                logError("No se puede inicializar porque el SDK no está cargado");
                return;
            }
            
            try {
                logInfo("Intentando registrar evento PageLoad...");
                
                ZOHO.embeddedApp.on("PageLoad", function(entity) {
                    logSuccess("Evento PageLoad recibido");
                    logInfo("Datos de la entidad: " + JSON.stringify(entity));
                    
                    sdkInitialized = true;
                });
                
                logInfo("Intentando inicializar SDK...");
                
                ZOHO.embeddedApp.init()
                    .then(function() {
                        logSuccess("SDK inicializado correctamente");
                        sdkInitialized = true;
                        
                        // Intentar obtener datos del registro
                        getRecordData();
                    })
                    .catch(function(error) {
                        logError("Error al inicializar SDK: " + error);
                    });
            } catch (error) {
                logError("Error al intentar inicializar: " + error);
            }
        }
        
        // Obtener datos del registro actual
        function getRecordData() {
            try {
                logInfo("Intentando obtener información del registro actual...");
                
                ZOHO.CRM.UI.Record.getRecordInfo()
                    .then(function(recordInfo) {
                        logSuccess("Información del registro obtenida");
                        logInfo("Datos del registro: " + JSON.stringify(recordInfo));
                        
                        if (recordInfo && recordInfo.id) {
                            logInfo("Obteniendo detalles completos del registro...");
                            
                            ZOHO.CRM.API.getRecord({
                                Entity: recordInfo.module, 
                                RecordID: recordInfo.id
                            })
                            .then(function(response) {
                                logSuccess("Datos del registro obtenidos correctamente");
                                logInfo("Respuesta de API: " + JSON.stringify(response));
                            })
                            .catch(function(error) {
                                logError("Error al obtener datos del registro: " + error);
                            });
                        }
                    })
                    .catch(function(error) {
                        logError("Error al obtener información del registro: " + error);
                    });
            } catch (error) {
                logError("Error en getRecordData: " + error);
            }
        }
        
        // Actualizar estado del SDK
        function updateSDKStatus(isAvailable) {
            var statusElement = document.getElementById('sdk-status');
            
            if (isAvailable) {
                statusElement.className = "status-box status-ok";
                statusElement.innerHTML = "SDK de Zoho está disponible. Puede continuar con la inicialización.";
            } else {
                statusElement.className = "status-box status-error";
                statusElement.innerHTML = "SDK de Zoho NO está disponible. El widget no funcionará correctamente.";
            }
        }
        
        // Mostrar información del entorno
        function showEnvironmentInfo() {
            var info = {
                url: window.location.href,
                referrer: document.referrer,
                userAgent: navigator.userAgent,
                screenSize: window.innerWidth + 'x' + window.innerHeight,
                sdkLoaded: sdkLoaded,
                sdkInitialized: sdkInitialized,
                hasParent: (window.parent !== window),
                timestamp: new Date().toISOString()
            };
            
            logInfo("Información del entorno: " + JSON.stringify(info, null, 2));
        }
        
        // Funciones de registro
        function logInfo(message) {
            appendToLog(message, "log-info");
            console.log(message);
        }
        
        function logWarning(message) {
            appendToLog(message, "log-warning");
            console.warn(message);
        }
        
        function logError(message) {
            appendToLog(message, "log-error");
            console.error(message);
        }
        
        function logSuccess(message) {
            appendToLog(message, "log-success");
            console.log("%c" + message, "color: green");
        }
        
        function appendToLog(message, className) {
            var logContainer = document.getElementById('log-container');
            var timestamp = new Date().toISOString().substring(11, 19);
            var entry = document.createElement('div');
            entry.className = "log-entry " + className;
            entry.textContent = "[" + timestamp + "] " + message;
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        function clearLog() {
            var logContainer = document.getElementById('log-container');
            logContainer.innerHTML = '';
            logInfo("Registro limpiado");
        }
    </script>
</body>
</html>
